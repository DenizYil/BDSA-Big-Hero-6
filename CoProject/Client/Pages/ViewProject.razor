@page "/project/{Id}"
@inject NavigationManager _navManager
@layout AuthLayout
@inject HttpClient _client
@using CoProject.Shared;
@using Microsoft.AspNetCore.Authorization;
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider


<PageTitle>View Project - CoProject</PageTitle>

@if (_project == null)
{
    <p>Loading...</p>
}
else
{
    <h1 id="ProjectName">@_project.Name</h1>
    <h2 id="registered">Registered: @_project.Users.Count@(_project.Max != null && _project.Max > 0 ? $"/{_project.Max}" : "")</h2>

    <hr/>

    <div class="supervisorContainer">
        <img class="imageOfSupervisor" alt="PICTURE OF SUPERVISOR" src="https://via.placeholder.com/150">
        <p class="supervisorName">@_project.Supervisor.Name</p>
        <p class="createdBy">Created on @_project.Created</p>
    </div>

    <p class="projectDescription">
        @_project.Description
    </p>

    <div class="tags">
        @foreach (var t in _project.Tags)
        {
            <p class="tagName">@t</p>
        }
    </div>

    @if (usedLayout != null && usedLayout.loggedInUser != null && usedLayout.loggedInUser.Supervisor && usedLayout.loggedInUser.Id.Equals(_project.Supervisor.Id))
    {
        <a href="/editproject/@Id">
        <button id="editProject">
            Edit Project
        </button>
        </a>
    }
    @if (!usedLayout.loggedInUser.Supervisor)
    {
        <button id="joinProject">

            @if (!isUserJoined)
            {
                <a @onclick="Join">Join project</a>
            }
            else
            {
                <a @onclick="Leave">Leave project</a>
            }

        </button>
    }

    @if (usedLayout != null && usedLayout.loggedInUser != null && usedLayout.loggedInUser.Supervisor == true && usedLayout.loggedInUser.Id.Equals(_project.Supervisor.Id))
    {
        <button id="delete" @onclick=Delete>Delete</button>
    }

    <hr/>

    <p id="studentsRegistered">Students registered</p>

    <div id="bagOfStudents">

        @foreach (var u in _project.Users)
        {
            <div class="oneStudent">
                <div class="studentLeft">
                    <img class="studentImg" src="https://via.placeholder.com/150?text=student" alt="Image Of Student"/>
                </div>
                <div class="studentRight">
                    <p class="student">@u.Name</p>
                    <p class="email">
                        @u.Email<img src="/images/copyIcon.svg" class="material-icons"/>
                    </p>
                </div>
            </div>
        }
    </div>
}

@code {
    private ProjectDetailsDTO? _project;
    private bool isUserJoined = false;

    [CascadingParameter]
    public AuthLayout? usedLayout { get; set; }

    [Parameter]
    public string? Id { get; set; }

    protected override void OnInitialized()
    {
        if (Id == null)
        {
            _navManager.NavigateTo("/projects");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var projectResponse = await _client.GetAsync($"api/projects/{Id}");

        if (projectResponse.IsSuccessStatusCode && projectResponse.Content != null)
        {
            _project = await projectResponse.Content.ReadFromJsonAsync<ProjectDetailsDTO>();

            if (_project != null)
            {
                if (usedLayout != null && usedLayout.loggedInUser != null)
                {
                    foreach (var user in _project.Users)
                    {
                        Console.WriteLine(user.Id);
                    }
                    if (_project.Users.FirstOrDefault(u => u.Id.Equals(usedLayout.loggedInUser.Id)) != null)
                    {
                        isUserJoined = true;
                    }
                }
                else
                {
                    _navManager.NavigateTo("/");
                }
            }
            else
            {
                _navManager.NavigateTo("/projects?error=ProjectNotFound");
            }
        }
        else
        {
            _navManager.NavigateTo("/projects?error=JsonReturnError");
        }
    }

    private async void Join()
    {
        if (_project != null)
        {
            var response = await _client.PutAsJsonAsync($"api/projects/{_project.Id}/join", "");

            if (response.IsSuccessStatusCode)
            {
                _navManager.NavigateTo("/myprojects");
            }
            else
            {
                _navManager.NavigateTo($"/project/{Id}?error=JoinProjectError");
            }
        }
        else
        {
            _navManager.NavigateTo($"/project/{Id}?error=ProjectIsNull");
        }
    }

    private async void Leave()
    {
        if (_project != null)
        {
            var response = await _client.DeleteAsync($"api/projects/{_project.Id}/leave");

            if (response.IsSuccessStatusCode)
            {
                _navManager.NavigateTo("/myprojects");
            }
            else
            {
                _navManager.NavigateTo($"/project/{Id}?error=LeaveProjectError");
            }
        }
        else
        {
            _navManager.NavigateTo($"/project/{Id}?error=ProjectIsNull");
        }
    }

    private async void Delete()
    {
        if (_project != null)
        {
            var response = await _client.DeleteAsync($"api/projects/{_project.Id}");

            if (response.IsSuccessStatusCode)
            {
                _navManager.NavigateTo("/projects");
            }
            else
            {
                _navManager.NavigateTo("/projects?error=DeleteProjectError");
            }
        }
        else
        {
            _navManager.NavigateTo("/projects?error=ProjectNotFound");
        }
    }

}